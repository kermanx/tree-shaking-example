# Lacuna 分析文档

## 1. Lacuna 简介

**Lacuna** 是 JavaScript 死代码消除工具。

### 主要特点

- **用途**：识别并消除 JavaScript 应用中的死代码（未使用的函数）
- **方法**：结合多种静态和动态分析技术创建调用图，识别不可达函数

### 工作原理

- 创建概率调用图，每条边有权重（0-1）表示函数调用的可能性
- 使用阈值过滤低权重边来消除不太可能被调用的函数


### 优化级别

Lacuna 提供 4 个优化级别：

- **Level 0**: 仅分析，不进行优化
- **Level 1**: 用懒加载机制替换函数体
- **Level 2**: 移除函数体
- **Level 3**: 用 null 替换函数定义
- 支持多种分析器生成调用图：static、dynamic、nativecalls、acg、jelly、npm_cg(tajs、wala不太行，不支持ES6语法)

## 2. 项目中的 Lacuna 集成

### 集成实现

项目通过 `scripts/optimizer.ts` (第 154-245 行) 封装了 Lacuna 的调用流程：

1. **创建临时目录**：将输入代码保存为 `input.js`
2. **生成 HTML 入口文件**：创建 `index.html` 引用 JS 文件
3. **创建 package.json**：确保分析器兼容性
4. **调用 Lacuna**：通过 `lacuna_runner.js` 执行分析和优化
5. **读取结果**：从临时目录获取优化后的代码
6. **清理环境**：删除临时文件

### 默认配置

```javascript
{
  analyzer: { dynamic: 0.5 , jelly: 0.5 },  // 使用 Jelly 分析器，阈值 0.5
  optimizationLevel: 2        // 优化级别 2（移除函数体）
}
```

## 3. 测试结果

### 测试数据

测试结果保存在 `sizes.json` 文件中，展示了 Lacuna 在不同库上的优化效果。

**Gzip前：**

| 库 | 原始大小 | 减少比例 (level=1), 结果正确性 | 减少比例 (level=2), 结果正确性 | 减少比例 (level=3), 结果正确性 |
|---------|----------|-----------|-----------|-----------|
| antd | 1550610B (1.48 MB) |❌ 内存溢出 |  ❌ 内存溢出 | ❌ 内存溢出 |
| glob | 276805B (270 KB) | 122210B (55.9%), ❌ | 93591B (66.2%), ❌ | 90084B (67.5%), ❌ |
| js-yaml | 107394B (105 KB) | 96075B (10.5%), ❌ | 91581B (14.7%), ❌ | 90119B (16.1%), ❌ |
| lodash | 577770B (564 KB) | 553154B (4.3%), ✅ | 539619B (6.6%), ✅ | 534239B (7.5%), ❌ |
| lodash-es | 103180B (101 KB) | 103301B (-0.1%), ✅ | 102647B (0.5%), ✅ | 102559B (0.6%), ❌ |
| material-ui | 698562B (682 KB) | 682272B (2.3%), ✅ | 673260B (3.6%), ✅ | 670585B (4.0%), ❌ |
| novnc | 622673B (608 KB) | 346874B (44.3%), ❌ | 307020B (50.7%), ❌ | 302585B (51.4%), ❌ |
| react-icons | 1357280B (1.33 MB) | 268077B (80.2%), ✅ | 140651B (89.6%), ✅ | 116315B (91.4%), ❌ |
| remeda | 6665B (6.5 KB) | 7013B (-5.2%), ✅ | 6592B (1.1%), ✅ | 6571B (1.4%), ❌ |
| rxjs | 25487B (25 KB) | 24844B (2.5%), ✅ | 23734B (6.9%), ✅ | 23571B (7.5%), ❌ |
| sentry | 309673B (302 KB) | 266416B (14.0%), ❌ | 257012B (17.0%), ❌ | 255237B (17.6%), ❌ |
| vuetify | 304846B (298 KB) | 275589B (9.6%), ❌ | 257611B (15.5%), ❌ | 255414B (16.2%), ❌ |

**Gzip后：**
| 库 | 原始大小 | 减少比例 (level=1), 结果正确性 | 减少比例 (level=2), 结果正确性 | 减少比例 (level=3), 结果正确性 |
|---------|----------|-----------|-----------|-----------|
| antd | 310864B (304 KB) |  ❌ 内存溢出 |  ❌ 内存溢出 | ❌ 内存溢出 |
| glob | 61021B (60 KB) | 31103B (49.0%), ❌ | 26412B (56.7%), ❌ | 25544B (58.1%), ❌ |
| js-yaml | 25794B (25 KB) | 23070B (10.6%), ❌ | 22122B (14.2%), ❌ | 21888B (15.1%), ❌ |
| lodash | 99063B (97 KB) | 94471B (4.6%), ✅ | 91544B (7.6%), ✅ | 90604B (8.5%), ❌ |
| lodash-es | 22540B (22 KB) | 22719B (-0.8%), ✅ | 22434B (0.5%), ✅ | 22425B (0.5%), ❌ |
| material-ui | 134829B (132 KB) | 132904B (1.4%), ✅ | 130932B (2.9%), ✅ | 130447B (3.2%), ❌ |
| novnc | 141663B (138 KB) | 86820B (38.7%), ❌ | 80847B (42.9%), ❌ | 79650B (43.8%), ❌ |
| react-icons | 423681B (414 KB) | 38664B (90.9%), ✅ | 21895B (94.8%), ✅ | 21120B (95.0%), ❌ |
| remeda | 1939B (1.9 KB) | 2174B (-12.1%), ✅ | 1928B (0.6%), ✅ | 1922B (0.9%), ❌ |
| rxjs | 4952B (4.8 KB) | 5037B (-1.7%), ✅ | 4655B (6.0%), ✅ | 4627B (6.6%), ❌ |
| sentry | 84791B (83 KB) | 74268B (12.4%), ❌ | 71999B (15.1%), ❌ | 71523B (15.6%), ❌ |
| vuetify | 74360B (73 KB) | 67672B (9.0%), ❌ | 64401B (13.4%), ❌ | 63871B (14.1%), ❌ |
### 结果分析


## 4. 关键文件位置

### Lacuna 相关文件

- **主入口**：`vendor/Lacuna/lacuna_runner.js`
- **核心逻辑**：`vendor/Lacuna/lacunizer.js`
- **调用图**：`vendor/Lacuna/call_graph.js`
- **文档**：`vendor/Lacuna/README.md`

### 项目集成代码

- **优化器封装**：`scripts/optimizer.ts` (第 154-245 行)
- **CLI 接口**：`scripts/cli.ts`
- **打包器**：`scripts/bundle.ts`

### 测试相关

- **测试用例源文件**：`src/` 目录（包含 16 个测试文件）
  - `test-simple.js`
  - `rambda.js`
  - `lodash-es.js`
  - 等等
- **快照目录**：`snapshots/`
- **测试结果**：`sizes.json`
